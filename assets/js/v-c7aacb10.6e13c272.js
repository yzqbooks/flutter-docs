"use strict";(self.webpackChunkflutter_docs=self.webpackChunkflutter_docs||[]).push([[3737],{43689:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t=JSON.parse('{"key":"v-c7aacb10","path":"/chapter6/scroll_controller.html","title":"6.4 滚动监听及控制","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"6.4.1 ScrollController","slug":"_6-4-1-scrollcontroller","link":"#_6-4-1-scrollcontroller","children":[{"level":3,"title":"示例","slug":"示例","link":"#示例","children":[]},{"level":3,"title":"滚动位置恢复","slug":"滚动位置恢复","link":"#滚动位置恢复","children":[]},{"level":3,"title":"ScrollPosition","slug":"scrollposition","link":"#scrollposition","children":[]},{"level":3,"title":"ScrollController控制原理","slug":"scrollcontroller控制原理","link":"#scrollcontroller控制原理","children":[]}]},{"level":2,"title":"6.4.2 滚动监听","slug":"_6-4-2-滚动监听","link":"#_6-4-2-滚动监听","children":[{"level":3,"title":"示例","slug":"示例-1","link":"#示例-1","children":[]}]}],"git":{"createdTime":1654491188000,"updatedTime":1654491188000,"contributors":[{"name":"yzqdev","email":"yzqdev@outlook.com","commits":1}]},"readingTime":{"minutes":7.87,"words":2360},"filePathRelative":"chapter6/scroll_controller.md","localizedDate":"2022年6月6日","excerpt":""}')},37261:(n,s,a)=>{a.r(s),a.d(s,{default:()=>i});var t=a(6808);const e=a.p+"assets/img/6-10.12fece21.png",o=a.p+"assets/img/6-11.0830ab14.png",c=a.p+"assets/img/6-12.4a2522c1.png",p=[(0,t.uE)('<h1 id="_6-4-滚动监听及控制" tabindex="-1"><a class="header-anchor" href="#_6-4-滚动监听及控制" aria-hidden="true">#</a> 6.4 滚动监听及控制</h1><p>在前几节中，我们介绍了Flutter中常用的可滚动组件，也说过可以用<code>ScrollController</code>来控制可滚动组件的滚动位置，本节先介绍一下<code>ScrollController</code>，然后以<code>ListView</code>为例，展示一下<code>ScrollController</code>的具体用法。最后，再介绍一下路由切换时如何来保存滚动位置。</p><h2 id="_6-4-1-scrollcontroller" tabindex="-1"><a class="header-anchor" href="#_6-4-1-scrollcontroller" aria-hidden="true">#</a> 6.4.1 ScrollController</h2><p><code>ScrollController</code>构造函数如下：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token class-name">ScrollController</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  double initialScrollOffset <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token comment">//初始滚动位置</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>keepScrollOffset <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//是否保存滚动位置</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们介绍一下<code>ScrollController</code>常用的属性和方法：</p><ul><li><code>offset</code>：可滚动组件当前的滚动位置。</li><li><code>jumpTo(double offset)</code>、<code>animateTo(double offset,...)</code>：这两个方法用于跳转到指定的位置，它们不同之处在于，后者在跳转时会执行一个动画，而前者不会。</li></ul><p><code>ScrollController</code>还有一些属性和方法，我们将在后面原理部分解释。</p><h4 id="滚动监听" tabindex="-1"><a class="header-anchor" href="#滚动监听" aria-hidden="true">#</a> 滚动监听</h4><p><code>ScrollController</code>间接继承自<code>Listenable</code>，我们可以根据<code>ScrollController</code>来监听滚动事件，如：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code>controller<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">print</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例</h3><p>我们创建一个<code>ListView</code>，当滚动位置发生变化时，我们先打印出当前滚动位置，然后判断当前位置是否超过1000像素，如果超过则在屏幕右下角显示一个“返回顶部”的按钮，该按钮点击后可以使ListView恢复到初始位置；如果没有超过1000像素，则隐藏“返回顶部”按钮。代码如下：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code>\n<span class="token keyword">class</span> <span class="token class-name">ScrollControllerTestRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>\n  <span class="token metadata function">@override</span>\n  <span class="token class-name">ScrollControllerTestRouteState</span> <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token class-name">ScrollControllerTestRouteState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ScrollControllerTestRouteState</span> <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScrollControllerTestRoute</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>\n  <span class="token class-name">ScrollController</span> _controller <span class="token operator">=</span> <span class="token class-name">ScrollController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  bool showToTopBtn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//是否显示“返回到顶部”按钮</span>\n\n  <span class="token metadata function">@override</span>\n  <span class="token keyword">void</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">//监听滚动事件，打印滚动位置</span>\n    _controller<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">print</span><span class="token punctuation">(</span>_controller<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//打印滚动位置</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>_controller<span class="token punctuation">.</span>offset <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token operator">&amp;&amp;</span> showToTopBtn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          showToTopBtn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_controller<span class="token punctuation">.</span>offset <span class="token operator">&gt;=</span> <span class="token number">1000</span> <span class="token operator">&amp;&amp;</span> showToTopBtn <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          showToTopBtn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token metadata function">@override</span>\n  <span class="token keyword">void</span> <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//为了避免内存泄露，需要调用_controller.dispose</span>\n    _controller<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token metadata function">@override</span>\n  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span>\n      appBar<span class="token punctuation">:</span> <span class="token class-name">AppBar</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;滚动控制&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      body<span class="token punctuation">:</span> <span class="token class-name">Scrollbar</span><span class="token punctuation">(</span>\n        child<span class="token punctuation">:</span> <span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>\n          itemCount<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>\n          itemExtent<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span> <span class="token comment">//列表项高度固定时，显式指定高度是一个好习惯(性能消耗小)</span>\n          controller<span class="token punctuation">:</span> _controller<span class="token punctuation">,</span>\n          itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token class-name">ListTile</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">index</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n      floatingActionButton<span class="token punctuation">:</span> <span class="token operator">!</span>showToTopBtn <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token class-name">FloatingActionButton</span><span class="token punctuation">(</span>\n        child<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>arrow_upward<span class="token punctuation">)</span><span class="token punctuation">,</span>\n        onPressed<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">//返回到顶部时执行动画</span>\n          _controller<span class="token punctuation">.</span><span class="token function">animateTo</span><span class="token punctuation">(</span>\n            <span class="token number">.0</span><span class="token punctuation">,</span>\n            duration<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            curve<span class="token punctuation">:</span> <span class="token class-name">Curves</span><span class="token punctuation">.</span>ease<span class="token punctuation">,</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码说明已经包含在注释里，运行效果如图6-10、6-11所示：</p><p><img src="'+e+'" alt="图6-10"><img src="'+o+'" alt="图6-11"></p><p>由于列表项高度为 50 像素，当滑动到第 20 个列表项后，右下角 “返回顶部” 按钮会显示，点击该按钮，ListView 会在返回顶部的过程中执行一个滚动动画，动画时间是 200 毫秒，动画曲线是 <code>Curves.ease</code>，关于动画的详细内容我们将在后面“动画”一章中详细介绍。</p><h3 id="滚动位置恢复" tabindex="-1"><a class="header-anchor" href="#滚动位置恢复" aria-hidden="true">#</a> 滚动位置恢复</h3><p><code>PageStorage</code>是一个用于保存页面(路由)相关数据的组件，它并不会影响子树的UI外观，其实，<code>PageStorage</code>是一个功能型组件，它拥有一个存储桶（bucket），子树中的Widget可以通过指定不同的<code>PageStorageKey</code>来存储各自的数据或状态。</p><p>每次滚动结束，可滚动组件都会将滚动位置<code>offset</code>存储到<code>PageStorage</code>中，当可滚动组件重新创建时再恢复。如果<code>ScrollController.keepScrollOffset</code>为<code>false</code>，则滚动位置将不会被存储，可滚动组件重新创建时会使用<code>ScrollController.initialScrollOffset</code>；<code>ScrollController.keepScrollOffset</code>为<code>true</code>时，可滚动组件在<strong>第一次</strong>创建时，会滚动到<code>initialScrollOffset</code>处，因为这时还没有存储过滚动位置。在接下来的滚动中就会存储、恢复滚动位置，而<code>initialScrollOffset</code>会被忽略。</p><p>当一个路由中包含多个可滚动组件时，如果你发现在进行一些跳转或切换操作后，滚动位置不能正确恢复，这时你可以通过显式指定<code>PageStorageKey</code>来分别跟踪不同的可滚动组件的位置，如：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token class-name">ListView</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token class-name">PageStorageKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token class-name">ListView</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token class-name">PageStorageKey</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不同的<code>PageStorageKey</code>，需要不同的值，这样才可以为不同可滚动组件保存其滚动位置。</p><blockquote><p>注意：一个路由中包含多个可滚动组件时，如果要分别跟踪它们的滚动位置，并非一定就得给他们分别提供<code>PageStorageKey</code>。这是因为Scrollable本身是一个StatefulWidget，它的状态中也会保存当前滚动位置，所以，只要可滚动组件本身没有被从树上detach掉，那么其State就不会销毁(dispose)，滚动位置就不会丢失。只有当Widget发生结构变化，导致可滚动组件的State销毁或重新构建时才会丢失状态，这种情况就需要显式指定<code>PageStorageKey</code>，通过<code>PageStorage</code>来存储滚动位置，一个典型的场景是在使用<code>TabBarView</code>时，在Tab发生切换时，Tab页中的可滚动组件的State就会销毁，这时如果想恢复滚动位置就需要指定<code>PageStorageKey</code>。</p></blockquote><h3 id="scrollposition" tabindex="-1"><a class="header-anchor" href="#scrollposition" aria-hidden="true">#</a> ScrollPosition</h3><p>ScrollPosition是用来保存可滚动组件的滚动位置的。一个<code>ScrollController</code>对象可以同时被多个可滚动组件使用，<code>ScrollController</code>会为每一个可滚动组件创建一个<code>ScrollPosition</code>对象，这些<code>ScrollPosition</code>保存在<code>ScrollController</code>的<code>positions</code>属性中（<code>List&lt;ScrollPosition&gt;</code>）。<code>ScrollPosition</code>是真正保存滑动位置信息的对象，<code>offset</code>只是一个便捷属性：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code>double <span class="token keyword">get</span> offset <span class="token operator">=</span><span class="token operator">&gt;</span> position<span class="token punctuation">.</span>pixels<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>一个<code>ScrollController</code>虽然可以对应多个可滚动组件，但是有一些操作，如读取滚动位置<code>offset</code>，则需要一对一！但是我们仍然可以在一对多的情况下，通过其它方法读取滚动位置，举个例子，假设一个<code>ScrollController</code>同时被两个可滚动组件使用，那么我们可以通过如下方式分别读取他们的滚动位置：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\ncontroller<span class="token punctuation">.</span>positions<span class="token punctuation">.</span><span class="token function">elementAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixels\ncontroller<span class="token punctuation">.</span>positions<span class="token punctuation">.</span><span class="token function">elementAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixels\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    \n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以通过<code>controller.positions.length</code>来确定<code>controller</code>被几个可滚动组件使用。</p><h4 id="scrollposition的方法" tabindex="-1"><a class="header-anchor" href="#scrollposition的方法" aria-hidden="true">#</a> ScrollPosition的方法</h4><p><code>ScrollPosition</code>有两个常用方法：<code>animateTo()</code> 和 <code>jumpTo()</code>，它们是真正来控制跳转滚动位置的方法，<code>ScrollController</code>的这两个同名方法，内部最终都会调用<code>ScrollPosition</code>的。</p><h3 id="scrollcontroller控制原理" tabindex="-1"><a class="header-anchor" href="#scrollcontroller控制原理" aria-hidden="true">#</a> ScrollController控制原理</h3><p>我们来介绍一下<code>ScrollController</code>的另外三个方法：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token class-name">ScrollPosition</span> <span class="token function">createScrollPosition</span><span class="token punctuation">(</span>\n    <span class="token class-name">ScrollPhysics</span> physics<span class="token punctuation">,</span>\n    <span class="token class-name">ScrollContext</span> context<span class="token punctuation">,</span>\n    <span class="token class-name">ScrollPosition</span> oldPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">ScrollPosition</span> position<span class="token punctuation">)</span> <span class="token punctuation">;</span>\n<span class="token keyword">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token class-name">ScrollPosition</span> position<span class="token punctuation">)</span> <span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当<code>ScrollController</code>和可滚动组件关联时，可滚动组件首先会调用<code>ScrollController</code>的<code>createScrollPosition()</code>方法来创建一个<code>ScrollPosition</code>来存储滚动位置信息，接着，可滚动组件会调用<code>attach()</code>方法，将创建的<code>ScrollPosition</code>添加到<code>ScrollController</code>的<code>positions</code>属性中，这一步称为“注册位置”，只有注册后<code>animateTo()</code> 和 <code>jumpTo()</code>才可以被调用。</p><p>当可滚动组件销毁时，会调用<code>ScrollController</code>的<code>detach()</code>方法，将其<code>ScrollPosition</code>对象从<code>ScrollController</code>的<code>positions</code>属性中移除，这一步称为“注销位置”，注销后<code>animateTo()</code> 和 <code>jumpTo()</code> 将不能再被调用。</p><p>需要注意的是，<code>ScrollController</code>的<code>animateTo()</code> 和 <code>jumpTo()</code>内部会调用所有<code>ScrollPosition</code>的<code>animateTo()</code> 和 <code>jumpTo()</code>，以实现所有和该<code>ScrollController</code>关联的可滚动组件都滚动到指定的位置。</p><h2 id="_6-4-2-滚动监听" tabindex="-1"><a class="header-anchor" href="#_6-4-2-滚动监听" aria-hidden="true">#</a> 6.4.2 滚动监听</h2><p>Flutter Widget树中子Widget可以通过发送通知（Notification）与父(包括祖先)Widget通信。父级组件可以通过<code>NotificationListener</code>组件来监听自己关注的通知，这种通信方式类似于Web开发中浏览器的事件冒泡，我们在Flutter中沿用“冒泡”这个术语，关于通知冒泡我们将在后面“事件处理与通知”一章中详细介绍。</p><p>可滚动组件在滚动时会发送<code>ScrollNotification</code>类型的通知，<code>ScrollBar</code>正是通过监听滚动通知来实现的。通过<code>NotificationListener</code>监听滚动事件和通过<code>ScrollController</code>有两个主要的不同：</p><ol><li>通过NotificationListener可以在从可滚动组件到widget树根之间任意位置都能监听。而<code>ScrollController</code>只能和具体的可滚动组件关联后才可以。</li><li>收到滚动事件后获得的信息不同；<code>NotificationListener</code>在收到滚动事件时，通知中会携带当前滚动位置和ViewPort的一些信息，而<code>ScrollController</code>只能获取当前滚动位置。</li></ol><h3 id="示例-1" tabindex="-1"><a class="header-anchor" href="#示例-1" aria-hidden="true">#</a> 示例</h3><p>下面，我们监听<code>ListView</code>的滚动通知，然后显示当前滚动进度百分比：</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token keyword">import</span> <span class="token string-literal"><span class="token string">&#39;package:flutter/material.dart&#39;</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ScrollNotificationTestRoute</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>\n  <span class="token metadata function">@override</span>\n  _ScrollNotificationTestRouteState <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>\n      <span class="token function">_ScrollNotificationTestRouteState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">class</span> _ScrollNotificationTestRouteState\n    <span class="token keyword">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScrollNotificationTestRoute</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>\n  <span class="token class-name">String</span> _progress <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;0%&quot;</span></span><span class="token punctuation">;</span> <span class="token comment">//保存进度百分比</span>\n\n  <span class="token metadata function">@override</span>\n  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token class-name">Scrollbar</span><span class="token punctuation">(</span>\n      <span class="token comment">//进度条</span>\n      <span class="token comment">// 监听滚动通知</span>\n      child<span class="token punctuation">:</span> <span class="token class-name">NotificationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScrollNotification</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>\n        onNotification<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">ScrollNotification</span> notification<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          double progress <span class="token operator">=</span> notification<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>pixels <span class="token operator">/</span>\n              notification<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>maxScrollExtent<span class="token punctuation">;</span>\n          <span class="token comment">//重新构建</span>\n          <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            _progress <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression"><span class="token punctuation">(</span>progress <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">%&quot;</span></span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;BottomEdge: </span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">notification<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>extentAfter <span class="token operator">==</span> <span class="token number">0</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n          <span class="token comment">//return true; //放开此行注释后，进度条将失效</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        child<span class="token punctuation">:</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span>\n          alignment<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>\n          children<span class="token punctuation">:</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Widget</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>\n            <span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>\n              itemCount<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>\n              itemExtent<span class="token punctuation">:</span> <span class="token number">50.0</span><span class="token punctuation">,</span>\n              itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">ListTile</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">index</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token class-name">CircleAvatar</span><span class="token punctuation">(</span>\n              <span class="token comment">//显示进度百分比</span>\n              radius<span class="token punctuation">:</span> <span class="token number">30.0</span><span class="token punctuation">,</span>\n              child<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>_progress<span class="token punctuation">)</span><span class="token punctuation">,</span>\n              backgroundColor<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black54<span class="token punctuation">,</span>\n            <span class="token punctuation">)</span>\n          <span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果如图6-12所示：</p><p><img src="'+c+'" alt="图6-12"></p><p>在接收到滚动事件时，参数类型为<code>ScrollNotification</code>，它包括一个<code>metrics</code>属性，它的类型是<code>ScrollMetrics</code>，该属性包含当前ViewPort及滚动位置等信息：</p><ul><li><code>pixels</code>：当前滚动位置。</li><li><code>maxScrollExtent</code>：最大可滚动长度。</li><li><code>extentBefore</code>：滑出ViewPort顶部的长度；此示例中相当于顶部滑出屏幕上方的列表长度。</li><li><code>extentInside</code>：ViewPort内部长度；此示例中屏幕显示的列表部分的长度。</li><li><code>extentAfter</code>：列表中未滑入ViewPort部分的长度；此示例中列表底部未显示到屏幕范围部分的长度。</li><li><code>atEdge</code>：是否滑到了可滚动组件的边界（此示例中相当于列表顶或底部）。</li></ul><p>ScrollMetrics还有一些其它属性，读者可以自行查阅API文档。</p>',50)],l={},i=(0,a(18580).Z)(l,[["render",function(n,s){return(0,t.wg)(),(0,t.iD)("div",null,p)}]])},18580:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}}}]);